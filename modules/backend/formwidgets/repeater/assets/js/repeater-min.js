"use strict";oc.Module.register("backend.formwidget.repeater.base",(function(){class RepeaterFormWidgetBase extends oc.FoundationPlugin{constructor(element,config){super(element,config),this.$el=$(element),this.$itemContainer=$("> .field-repeater-items",this.$el),this.itemCount=0,this.canAdd=!0,this.canRemove=!0,this.repeaterId=$.oc.domIdManager.generate("repeater"),this.markDisposable(),this.init()}static get DATANAME(){return"ocRepeater"}static get DEFAULTS(){return{useReorder:!0,sortableHandle:".repeater-item-handle",removeHandler:"onRemoveItem",useDuplicate:!0,duplicateHandler:"onDuplicateItem",removeConfirm:"Are you sure?",itemsExpanded:!0,titleFrom:null,minItems:null,maxItems:null}}init(){this.config.useReorder&&this.bindSorting();var headSelect=this.selectorHeader;this.$el.on("change",headSelect+" input[type=checkbox]",this.proxy(this.clickItemCheckbox)),this.$el.on("click",headSelect+" [data-repeater-move-up]",this.proxy(this.clickMoveItemUp)),this.$el.on("click",headSelect+" [data-repeater-move-down]",this.proxy(this.clickMoveItemDown)),this.$el.on("click",headSelect+" [data-repeater-remove]",this.proxy(this.clickRemoveItem)),this.$el.on("click",headSelect+" [data-repeater-duplicate]",this.proxy(this.clickDuplicateItem)),this.$el.on("show.bs.dropdown",headSelect+" .repeater-item-dropdown",this.proxy(this.showItemMenu)),this.$toolbar=$(this.selectorToolbar,this.$el),this.$toolbar.on("click","> [data-repeater-cmd=add-group]",this.proxy(this.clickAddGroupButton)),this.$toolbar.on("click","> [data-repeater-cmd=add]",this.proxy(this.onAddItemButton)),this.$toolbar.on("ajaxDone","> [data-repeater-cmd=add]",this.proxy(this.onAddItemSuccess)),this.$el.one("dispose-control",this.proxy(this.dispose)),this.initToolbarExtensionPoint(),this.initExternalToolbarEventBus(),this.mountExternalToolbarEventBusEvents(),this.countItems(),this.togglePrompt(),this.extendExternalToolbar()}dispose(){this.config.useReorder&&this.sortable.destroy();var headSelect=this.selectorHeader;this.$el.off("change",headSelect+" input[type=checkbox]",this.proxy(this.clickItemCheckbox)),this.$el.off("click",headSelect+" [data-repeater-move-up]",this.proxy(this.clickMoveItemUp)),this.$el.off("click",headSelect+" [data-repeater-move-down]",this.proxy(this.clickMoveItemDown)),this.$el.off("click",headSelect+" [data-repeater-remove]",this.proxy(this.clickRemoveItem)),this.$el.off("click",headSelect+" [data-repeater-duplicate]",this.proxy(this.clickDuplicateItem)),this.$el.off("show.bs.dropdown",headSelect+" .repeater-item-dropdown",this.proxy(this.showItemMenu)),this.$toolbar.off("click","> [data-repeater-cmd=add-group]",this.proxy(this.clickAddGroupButton)),this.$toolbar.off("click","> [data-repeater-cmd=add]",this.proxy(this.onAddItemButton)),this.$toolbar.off("ajaxDone","> [data-repeater-cmd=add]",this.proxy(this.onAddItemSuccess)),this.$el.off("dispose-control",this.proxy(this.dispose)),this.$el.removeData("oc.repeater"),this.unmountExternalToolbarEventBusEvents(),this.$el=null,this.$toolbar=null,this.$sortableBody=null,super.dispose()}bindSorting(){this.$sortableBody=$(this.selectorSortable,this.$el),this.sortable=Sortable.create(this.$sortableBody.get(0),{animation:150,multiDrag:!0,avoidImplicitDeselect:!0,handle:this.config.sortableHandle,onEnd:this.proxy(this.onSortableEnd)})}onSortableEnd(ev){this.eventSortableOnEnd()}clickItemCheckbox(ev){var $target=$(ev.target),$item=$target.closest("li"),checked=$target.is(":checked");$item.toggleClass("is-checked",checked),checked?Sortable.utils.select($item.get(0)):Sortable.utils.deselect($item.get(0))}showItemMenu(ev){var templateHtml=$("> [data-item-menu-template]",this.$el).html(),$target=$(ev.target),$item=$target.closest("li"),$dropdownList=$(".dropdown-menu:first",$target.closest(".dropdown"));$dropdownList.html(templateHtml),this.eventMenuFilter($item,$dropdownList)}clickRemoveItem(ev){$(ev.target).closest("li").hasClass("disabled")||this.onRemoveItem(this.findItemFromTarget(ev.target))}onRemoveItem($item){var self=this,$items=this.getCheckedItemsOrItem($item),itemData=[];$.each($items,(function(k,item){itemData.push({repeater_index:$(item).data("repeater-index"),repeater_group:$(item).data("repeater-group")})})),$item.request(this.config.removeHandler,{data:{_repeater_items:itemData},confirm:this.config.removeConfirm,afterUpdate:function(){self.onRemoveItemSuccess($items)}})}onRemoveItemSuccess($items){var self=this;$.each($items,(function(k,item){var $item=$(item);self.diposeItem($item),$item.remove(),self.eventOnRemoveItem($item),self.countItems(),self.triggerChange()}))}clickDuplicateItem(ev){$(ev.target).closest("li").hasClass("disabled")||(this.eventOnAddItem(),this.onDuplicateItem(this.findItemFromTarget(ev.target)))}onDuplicateItem($item){var self=this,itemData={_repeater_index:$item.data("repeater-index"),_repeater_group:$item.data("repeater-group")};$item.request(this.config.duplicateHandler,{data:itemData,afterUpdate:function(data){data.result?self.onDuplicateItemSuccess($item,data.result.duplicateIndex):self.eventOnErrorAddItem()}})}onDuplicateItemSuccess($item,duplicateIndex){var itemIndex=$item.data("repeater-index"),$duplicateItem=$("> li[data-repeater-index="+duplicateIndex+"]",this.$itemContainer);this.findItemFromIndex(itemIndex).after($duplicateItem),this.countItems(),this.triggerChange()}clickMoveItemUp(ev){var $item=this.findItemFromTarget(ev.target);$item.prev().before($item),this.onSortableEnd()}clickMoveItemDown(ev){var $item=this.findItemFromTarget(ev.target);$item.next().after($item),this.onSortableEnd()}onAddItemButton(ev){this.eventOnAddItem()}clickAddGroupButton(ev){var self=this,templateHtml=$("> [data-group-palette-template]",this.$el).html(),$target=$(ev.target),$form=this.$el.closest("form");$target.ocPopover({content:templateHtml});var $container=$target.data("oc.popover").$container;oc.Events.dispatch("render"),$container.on("click","a",(function(ev){setTimeout((function(){$(ev.target).trigger("close.oc.popover")}),2)})).on("ajaxSetup","[data-repeater-add]",(function(ev,context){context.options.form=$form.get(0),$target.addClass("oc-loading"),$form.one("ajaxComplete",(function(){$target.removeClass("oc-loading"),self.itemCount++,self.triggerChange()})),self.eventOnAddItem()}))}onAddItemSuccess(ev){this.itemCount++,this.triggerChange()}triggerChange(){this.togglePrompt(),this.$el.closest("[data-field-name]").trigger("change.oc.formwidget"),this.eventOnChange()}togglePrompt(){this.config.minItems&&this.config.minItems>0&&(this.canRemove=this.itemCount>this.config.minItems),this.config.maxItems&&this.config.maxItems>0&&(this.canAdd=this.itemCount<this.config.maxItems),this.$toolbar.toggle(this.canAdd),$("> [data-repeater-pointer-input]:first",this.$el).attr("disabled",!!this.itemCount)}getCollapseTitle($item){var $target=$item,titleFromAttr=this.getTitleFromAttribute($item),defaultText=this.$el.data("default-title"),explicitText=$item.data("item-title"),foundTitleFrom=!1;if(explicitText&&!titleFromAttr)return explicitText;if(titleFromAttr){var $titleFrom=$('[data-field-name="'+titleFromAttr+'"]',$item);$titleFrom.length&&($target=$titleFrom,foundTitleFrom=!0)}if(explicitText&&!foundTitleFrom)return explicitText;var result="",$textInput=$("input[type=text]:first, select:first, textarea:first",$target).first();if($textInput.length)result=$textInput.is("select")?$textInput.find("option:selected").text():$textInput.is("textarea")?$("<div />").html($textInput.val()).text().substring(0,255):$textInput.val();else{var $disabledTextInput=$(".text-field:first > .form-control",$target);$disabledTextInput.length&&(result=$disabledTextInput.text())}return result||defaultText}getTitleFromAttribute($item){if(this.config.titleFrom)return this.config.titleFrom;var itemTitleFrom=$item.data("title-from");return itemTitleFrom||null}findItemFromIndex(itemIndex){return $("> li[data-repeater-index="+itemIndex+"]:first",this.$itemContainer)}findItemFromTarget(target){return $(target).closest(".repeater-header").closest("li")}diposeItem($item){$("[data-disposable]",$item).each((function(){var $el=$(this),control=$el.data("control"),widget=$el.data("oc."+control);widget&&"function"==typeof widget.dispose&&widget.dispose()}))}getCheckedItemsOrItem($item){var $items=this.getCheckedItems();return $items.length||($items=[$item]),$items}getCheckedItems(){var $checkboxes=$(this.selectorChecked,this.$el),result=[];return $.each($checkboxes,(function(k,$checkbox){result.push($checkbox.closest("li"))})),result}countItems(){this.itemCount=$("> .field-repeater-item",this.$itemContainer).length,this.$el.toggleClass("repeater-empty",0===this.itemCount)}initToolbarExtensionPoint(){if(!this.config.externalToolbarAppState)return;const parts=this.config.externalToolbarAppState.split("::");if(2!==parts.length)throw new Error("Invalid externalToolbarAppState format. Expected format: module.name::stateElementName");const app=oc.Module.import(parts[0]);this.toolbarExtensionPoint=app.state[parts[1]]}initExternalToolbarEventBus(){if(!this.config.externalToolbarEventBus)return;const parts=this.config.externalToolbarEventBus.split("::");if(2!==parts.length)throw new Error("Invalid externalToolbarEventBus format. Expected format: module.name::stateElementName");const module=oc.Module.import(parts[0]);this.externalToolbarEventBusObj=module.state[parts[1]]}mountExternalToolbarEventBusEvents(){this.externalToolbarEventBusObj&&(this.externalToolbarEventBusObj.$on("toolbarcmd",this.proxy(this.onToolbarExternalCommand)),this.externalToolbarEventBusObj.$on("extendapptoolbar",this.proxy(this.extendExternalToolbar)))}unmountExternalToolbarEventBusEvents(){this.externalToolbarEventBusObj&&(this.externalToolbarEventBusObj.$off("toolbarcmd",this.proxy(this.onToolbarExternalCommand)),this.externalToolbarEventBusObj.$off("extendapptoolbar",this.proxy(this.extendExternalToolbar)))}onToolbarExternalCommand(ev){if("repeater-toolbar-"==ev.command.substring(0,"repeater-toolbar-".length)){if(/^repeater-toolbar-add,/.test(ev.command))return this.onAddItemClick(ev.command);var cmd=ev.command.substring("repeater-toolbar-".length);this.$el.find("> .field-repeater-builder > .field-repeater-toolbar, > .field-repeater-toolbar").find("[data-repeater-cmd="+cmd+"]").get(0).click(ev.ev)}}onAddItemClick(cmd){var parts=cmd.split(",");if(parts[1]==this.repeaterId){var requestData=oc.parseJSON("{"+parts[3]+"}"),that=this;this.externalToolbarEventBusObj.$emit("documentloadingstart"),this.$el.request(parts[2],{data:requestData}).always((function(){that.externalToolbarEventBusObj.$emit("documentloadingend"),that.countItems()}))}}buildAddMenuItems(){if(this.addMenuItems)return this.addMenuItems;var templateHtml=$("> [data-group-palette-template]",this.$el).html(),templateContainer=$(templateHtml),that=this;return this.addMenuItems=[],templateContainer.find("ul > li > a").each((function(){var $link=$(this),$icon=$link.find("i.list-icon");that.addMenuItems.push({type:"text",label:$link.find(".title").text(),icon:$icon.attr("class"),command:"repeater-toolbar-add,"+that.repeaterId+","+$link.data("request")+","+$link.data("requestData")})})),this.addMenuItems}extendExternalToolbar(){if(this.$el.is(":visible")&&this.toolbarExtensionPoint){this.toolbarExtensionPoint.splice(0,this.toolbarExtensionPoint.length),this.toolbarExtensionPoint.push({type:"separator"});var that=this;this.$el.find("> .field-repeater-builder > .field-repeater-toolbar a, > .field-repeater-toolbar a").each((function(){var $button=$(this),$icon=$button.find("i[class*=icon]"),menuitems=[],isAddButton="add-group"==$button.data("repeaterCmd");menuitems=!!isAddButton&&that.buildAddMenuItems(),that.toolbarExtensionPoint.push({type:isAddButton?"dropdown":"button",icon:$icon.attr("class"),label:$button.text(),command:"repeater-toolbar-"+$button.attr("data-repeater-cmd"),disabled:void 0!==$button.attr("disabled"),menuitems:menuitems})}))}}eventSortableOnEnd(){}eventOnChange(){}eventOnAddItem(){}eventOnRemoveItem(){}eventOnErrorAddItem(){}eventMenuFilter(){}}return RepeaterFormWidgetBase})),oc.Module.register("backend.formwidget.repeater.builder",(function(){const BaseClass=oc.Module.import("backend.formwidget.repeater.base");class RepeaterFormWidgetBuilder extends BaseClass{constructor(element,config){super(element,config)}init(){this.selectorToolbar="> .field-repeater-builder > .field-repeater-toolbar:first",this.selectorHeader="> .field-repeater-builder > .field-repeater-groups > .field-repeater-group > .repeater-header",this.selectorSortable="> .field-repeater-builder > .field-repeater-groups",this.selectorChecked="> .field-repeater-builder > .field-repeater-groups > .field-repeater-group > .repeater-header input[type=checkbox]:checked",this.$sidebar=$("> .field-repeater-builder > .field-repeater-groups:first",this.$el),this.$sidebar.on("click","> li:not(.is-placeholder)",this.proxy(this.clickBuilderItem)),$(document).on("render",this.proxy(this.builderOnRender)),this.transferBuilderItemHeaders(),this.selectBuilderItem(),super.init()}dispose(){this.$sidebar.off("click","> li:not(.is-placeholder)",this.proxy(this.clickBuilderItem)),$(document).off("render",this.proxy(this.builderOnRender)),this.$sidebar=null,super.dispose()}builderOnRender(){this.transferBuilderItemHeaders()}clickBuilderItem(ev){var $item=$(ev.target).closest(".field-repeater-group");$(ev.target).closest(".group-controls").length||(this.selectBuilderItem($item.data("repeater-index")),$(window).trigger("oc.updateUi"))}selectBuilderItem(itemIndex){void 0===itemIndex&&(itemIndex=$("> li:first",this.$sidebar).data("repeater-index")),$("> li.is-selected",this.$sidebar).removeClass("is-selected"),$("> li[data-repeater-index="+itemIndex+"]",this.$sidebar).addClass("is-selected"),$("> li.is-selected",this.$itemContainer).removeClass("is-selected"),$("> li[data-repeater-index="+itemIndex+"]",this.$itemContainer).addClass("is-selected"),this.setCollapsedTitles()}setCollapsedTitles(){var self=this;$("> .field-repeater-item",this.$itemContainer).each((function(){var $item=$(this),itemIndex=$item.data("repeater-index"),$groupItem=$("> li[data-repeater-index="+itemIndex+"]",self.$sidebar);$("[data-group-title]:first",$groupItem).html(self.getCollapseTitle($item))}))}transferBuilderItemHeaders(){var self=this,templateHtml=$("> [data-group-template]",this.$el).html();$("> .field-repeater-item > .repeater-header",this.$itemContainer).each((function(){var $groupItem=$(templateHtml),$item=$(this).closest("li");self.$sidebar.append($groupItem),$("[data-group-controls]:first",$groupItem).replaceWith($(this).addClass("group-controls")),$("[data-group-image]:first > i",$groupItem).addClass($item.data("item-icon")),$("[data-group-title]:first",$groupItem).html($item.data("item-title")),$("[data-group-description]:first",$groupItem).html($item.data("item-description")),$groupItem.attr("data-repeater-index",$item.data("repeater-index")),$groupItem.attr("data-repeater-group",$item.data("repeater-group")),$("li.is-placeholder:first",self.$sidebar).remove(),self.selectBuilderItem($item.data("repeater-index"))}))}eventMenuFilter($item,$list){$("[data-repeater-duplicate]",$list).closest("li").toggleClass("disabled",!this.canAdd),$("[data-repeater-remove]",$list).closest("li").toggleClass("disabled",!this.canRemove),$("[data-repeater-move-up]",$list).closest("li").toggle(!!$item.prev().length),$("[data-repeater-move-down]",$list).closest("li").toggle(!!$item.next().length),$("[data-repeater-expand]",$list).closest("li").hide(),$("[data-repeater-collapse]",$list).closest("li").hide()}eventSortableOnEnd(){var self=this;$("> li",this.$sidebar).each((function(){var itemIndex=$(this).data("repeater-index");self.$itemContainer.append(self.findItemFromIndex(itemIndex))}))}eventOnAddItem(){var templateHtml=$("> [data-group-loading-template]",this.$el).html(),$loadingItem=$(templateHtml);this.$sidebar.append($loadingItem)}eventOnErrorAddItem(){$("li.is-placeholder:first",this.$sidebar).remove()}eventOnRemoveItem($item){var itemIndex=$item.data("repeater-index"),$containerItem=this.findItemFromIndex(itemIndex);this.diposeItem($containerItem),$containerItem.remove()}}return addEventListener("render",(function(){document.querySelectorAll("[data-control=repeaterbuilder]").forEach((function(el){RepeaterFormWidgetBuilder.getOrCreateInstance(el)}))})),RepeaterFormWidgetBuilder})),oc.Module.register("backend.formwidget.repeater.accordion",(function(){const BaseClass=oc.Module.import("backend.formwidget.repeater.base");class RepeaterFormWidgetAccordion extends BaseClass{constructor(element,config){super(element,config)}init(){this.selectorToolbar="> .field-repeater-toolbar:first",this.selectorHeader="> .field-repeater-items > .field-repeater-item > .repeater-header",this.selectorSortable="> .field-repeater-items",this.selectorChecked="> .field-repeater-items > .field-repeater-item > .repeater-header input[type=checkbox]:checked";var headSelect=this.selectorHeader;this.$el.on("click",headSelect,this.proxy(this.clickItemHeader)),this.$el.on("click",headSelect+" [data-repeater-expand]",this.proxy(this.toggleCollapse)),this.$el.on("click",headSelect+" [data-repeater-collapse]",this.proxy(this.toggleCollapse)),this.applyExpandedItems(),super.init()}dispose(){var headSelect=this.selectorHeader;this.$el.off("click",headSelect,this.proxy(this.clickItemHeader)),this.$el.off("click",headSelect+" [data-repeater-expand]",this.proxy(this.toggleCollapse)),this.$el.off("click",headSelect+" [data-repeater-collapse]",this.proxy(this.toggleCollapse)),super.dispose()}clickItemHeader(ev){var $target=$(ev.target);if($target.hasClass("repeater-header")||$target.hasClass("repeater-item-title")||$target.hasClass("repeater-item-checkbox")){var $item=$target.closest(".field-repeater-item"),isCollapsed=$item.hasClass("collapsed");this.config.itemsExpanded||this.collapseAll(),isCollapsed?this.expand($item):this.collapse($item)}}applyExpandedItems(){if(!this.config.itemsExpanded){var items=$(this.$el).children(".field-repeater-items").children(".field-repeater-item"),self=this;$.each(items,(function(key,item){self.collapse($(item))}))}}toggleCollapse(ev){var self=this,$item=$(ev.target).closest(".field-repeater-item"),isCollapsed=$item.hasClass("collapsed");ev.preventDefault();var $items=this.getCheckedItemsOrItem($item);$.each($items,(function(k,item){isCollapsed?self.expand($(item)):self.collapse($(item))}))}collapseAll(){var self=this,$items=$("> .field-repeater-item",this.$itemContainer);$.each($items,(function(key,item){self.collapse($(item))}))}expandAll(){var self=this,$items=$("> .field-repeater-item",this.$itemContainer);$.each($items,(function(key,item){self.expand($(item))}))}collapse($item){$item.addClass("collapsed"),$("> .repeater-header > .repeater-item-title",$item).text(this.getCollapseTitle($item))}expand($item){$item.removeClass("collapsed"),$(window).trigger("oc.updateUi")}eventOnAddItem(){this.config.itemsExpanded||this.collapseAll()}eventMenuFilter($item,$list){$("[data-repeater-duplicate]",$list).closest("li").toggleClass("disabled",!this.canAdd),$("[data-repeater-remove]",$list).closest("li").toggleClass("disabled",!this.canRemove),$("[data-repeater-move-up]",$list).closest("li").toggle(!!$item.prev().length),$("[data-repeater-move-down]",$list).closest("li").toggle(!!$item.next().length),$("[data-repeater-expand]",$list).closest("li").toggle($item.hasClass("collapsed")),$("[data-repeater-collapse]",$list).closest("li").toggle(!$item.hasClass("collapsed"))}}return addEventListener("render",(function(){document.querySelectorAll("[data-control=repeateraccordion]").forEach((function(el){RepeaterFormWidgetAccordion.getOrCreateInstance(el)}))})),RepeaterFormWidgetAccordion}));
